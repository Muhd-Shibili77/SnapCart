<%- include ('../partial/admin-header')-%>
  <style>
    body {
      overflow-x: hidden;
    }

    .side-area {
      height: 100%;
      background-color: transparent;
    }

    .main-area {
      height: 100vh;
      margin-top: 20vh;
      background-color: transparent;
    }

    .admin-dashboard .dashboard {
      color: #505050 !important;
    }

    .side1 {
      width: 300px !important;
      height: 700px !important;
      background-color: rgba(170, 170, 170, 0.52);
      border-radius: 12px;
      margin-top: 0vh;
      position: fixed;
      margin-left: 40px;
    }

    .admin-name {
      margin-left: 135vh;
    }

    .search {
      width: 130vh;
      margin-left: 15vh;
      border-radius: 10px;
    }

    .products-1 {
      color: #000000 !important;
    }

    .dashboard {
      color: #505050 !important;
    }

    .dashboard:hover {
      color: #000000 !important;
    }

    .form-edge {
      border-radius: 10px;
      width: 30vh;
    }

    .image-preview {
      width: 50%;
      max-height: 150px;
      object-fit: cover;
      margin-bottom: 10px;
    }

    .image-form {
      width: 35vh !important;

    }
  </style>
  <section>
    <div class="row">
      <div class="col-md-3">
        <div class="container side-area">
          <div class="container-fluid side1">
            <div class="side-bar">
              <div class="container-7">
                <div>
                  <img style="margin: 50px;" src="/images/SnapCart.png" alt="">
                </div>
                <div class="dashboard-1">
                  <div class="dashboard-11"></div>
                  <a href="/admin/dashboard" class="dashboard btn"><img style="width: 35px; margin-right: 15px;"
                      src="/images/icons/dashboard.png" alt="">Dashboard </a>
                </div>

                <div class="users">
                  <div class="user"></div>
                  <a href="/admin/users" class="users-1 btn"><img style="width: 35px; margin-right: 15px;"
                      src="/images/icons/user.png" alt=""> Users </a>
                </div>
                <div class="products">
                  <div class="order"></div>
                  <a href="/admin/products" class="products-1 btn "><img style="width: 35px; margin-right: 15px;"
                      src="/images/icons/order (1).png" alt=""> Products </a>
                </div>
                <div class="offers">
                  <div class="order"></div>
                  <a href="#" class="offers-1 btn "><img style="width: 35px; margin-right: 15px;"
                      src="/images/icons/discount.png" alt=""> Offers </a>
                </div>
                <div class="orders">
                  <div class="shopping-cart"></div>
                  <a href="/admin/orders" class="orders-1 btn"><img style="width: 35px; margin-right: 15px;"
                      src="/images/icons/shopping-cart.png" alt="">Orders </a>
                </div>
                <div class="categories">
                  <div class="categories-2"></div>
                  <a href="/admin/category" class="categories-1 btn"><img style="width: 35px; margin-right: 15px;"
                      src="/images/icons/categories.png" alt=""> Categories </a>
                </div>
                <div class="brands">
                  <div class="brand-1"></div>
                  <a href="/admin/brand" class="brands-1 btn"><img style="width: 35px; margin-right: 15px;"
                      src="/images/icons/brand.png" alt=""> Brands </a>
                </div>
                <div class="coupon">
                  <div class="coupon-1"></div>
                  <a href="#" class="coupon-1 btn"><img style="width: 35px; margin-right: 15px;"
                      src="/images/icons/coupon (1).png" alt="">Coupon</a>
                </div>
                <div class="payment">
                  <div class="income-1"></div>
                  <a href="#" class="payment-1 btn"><img style="width: 35px; margin-right: 15px;"
                      src="/images/icons/income (1).png" alt=""> Payment </a>
                </div>
                <div class="payment-2">
                  <div class="logout-1"></div>
                  <a href="/admin/logout" class="logout btn"><img style="width: 35px; margin-right: 15px;"
                      src="/images/icons/logout.png" alt=""> Logout </a>
                </div>
              </div>
              <div class="icon">
                <div class="snap-cart-3"></div>
                <div class="line-21"></div>
              </div>
            </div>
          </div>

        </div>
      </div>
      <div class="col-md-9">
        <div class="container-fluid main-area">
          <div class="content">
            <h2 class="mb-4">Edit Product</h2>
            <div class="card shadow-sm">
              <div class="card-body">
                <form action="/admin/edit_product" method="post" enctype="multipart/form-data">
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label for="productName" class="form-label">Product Name</label>
                      <p class="text-danger">
                        <%= locals.exist ? exist : null %>
                      </p>
                      <input type="text" class="form-control" style="display: none;" name="productId" id="productId"
                        value="<%= product._id %>" required>
                      <input type="text" class="form-control" name="productName" id="productName"
                        value="<%= product.product_name %>" required>
                    </div>
                    <div class="col-md-6">

                      <label for="productPrice" class="form-label">Product Highlights</label>
                      <p></p>
                      <input type="text" class="form-control" name="productHighlights" id="productHighlights"
                        value="<%= product.product_highlights %>" required>
                    </div>
                  </div>
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label for="categoryName" class="form-label">Category</label>
                      <select class="form-select form-control" name="productCategory" id="productCategory" required>
                        <option disabled></option>
                        <option value="<%= product.category_id._id %>" selected>
                          <%= product.category_id.category_name %>
                        </option>

                        <% if(typeof category !='undefined' && category.length>0 ){ %>
                          <% category.forEach((category,index)=>{ %>
                            <% if(category.category_name !=product.category_id.category_name ) { %>
                              <option value="<%= product.category_id._id %>">
                                <%= category.category_name%>
                              </option>
                              <% } %>
                                <% }) %>
                                  <% }else{ %>
                                    <option disabled>No available categories</option>
                                    <% } %>
                      </select>
                    </div>
                    <div class="col-md-6">
                      <label for="productBrand" class="form-label">Brand</label>
                      <select class="form-select form-control" name="productBrand" id="productBrand" required>
                        <option disabled></option>
                        <option value="<%= product.brand_id._id %>" selected>
                          <%= product.brand_id.brand_name %>
                        </option>
                        <% if(typeof brand !='undefined' && brand.length>0 ){ %>

                          <% brand.forEach((brand,index)=>{ %>
                            <% if(brand.brand_name !=product.brand_id.brand_name ){ %>
                              <option value="<%= brand._id %>">
                                <%= brand.brand_name %>
                              </option>
                              <% } %>


                                <% }) %>
                                  <% }else{ %>
                                    <option disabled>No available brands</option>
                                    <% } %>

                      </select>
                    </div>
                  </div>

                  <% product.variants.forEach((element,index)=>{ %>

                    <div class="varient" id="varient">
                      <div class="row mb-3 mt-5 variant-row">
                        <div class="col-md-3">
                          <select class="form-select form-control form-edge" name="productSize[]" id="productSize"
                            required>
                            <option disabled>Size</option>
                            <option <%= element.size==='XS' ? 'selected' : '' %>>XS</option>
                            <option <%= element.size==='S' ? 'selected' : '' %>>S</option>
                            <option <%= element.size==='M' ? 'selected' : '' %>>M</option>
                            <option <%= element.size==='L' ? 'selected' : '' %>>L</option>
                            <option <%= element.size==='XL' ? 'selected' : '' %>>XL</option>
                            <option <%= element.size==='XXL' ? 'selected' : '' %>>XXL</option>
                            <option <%= element.size==='3XL' ? 'selected' : '' %>>3XL</option>
                          </select>
                        </div>
                        <div class="col-md-3">

                          <select class="form-select form-control form-edge" name="productColor[]" id="productColor"
                            required>
                            <option selected disabled>Color</option>
                            <option <%= element.color==='RED' ? 'selected' : '' %>>RED</option>
                            <option <%= element.color==='BLUE' ? 'selected' : '' %>>BLUE</option>
                            <option <%= element.color==='YELLOW' ? 'selected' : '' %>>YELLOW</option>
                            <option <%= element.color==='BLACK' ? 'selected' : '' %>>BLACK</option>
                            <option <%= element.color==='WHITE' ? 'selected' : '' %>>WHITE</option>
                            <option <%= element.color==='PINK' ? 'selected' : '' %>>PINK</option>
                            <option <%= element.color==='GREEN' ? 'selected' : '' %>>GREEN</option>
                            <option <%= element.color==='PURPLE' ? 'selected' : '' %>>PURPLE</option>
                            <option <%= element.color==='ORANGE' ? 'selected' : '' %>>ORANGE</option>
                            <option <%= element.color==='NAVY' ? 'selected' : '' %>>NAVY</option>
                            <option <%= element.color==='MAROON' ? 'selected' : '' %>>MAROON</option>
                          </select>
                        </div>
                        <div class="col-md-3">

                          <input type="number" class="form-control form-edge" name="productPrice" id="productPrice"
                            placeholder="Price" value="<%= element.price %>" required>
                        </div>
                        <div class="col-md-3">

                          <input type="number" class="form-control form-edge" name="productStock" id="productStock"
                            placeholder="Stock" value="<%= element.stock %>" required>
                        </div>
                      </div>





                      <div class="mb-3 mt-5">
                        <label for="productImage" class="form-label">Upload Image</label>
                        <div class="row mt-3">
                          <div class="col-md-6">

                            <img src="/<%= element.images[0] %>" alt="Image Preview" id="preview<%= index+1 %>-1"
                              class="image-preview">
                            <input class="form-control image-form" type="file" name="productImage1" id="varient<%= index+1 %>-image1"
                              onchange="previewImage(this, `preview<%= index+1 %>-1`)">
                            <button type="button" class="btn btn-outline-danger mt-2"
                              onclick="openCroppingModal(`preview<%= index+1 %>-1`,'varient<%= index+1 %>-image1')">Crop Image</button>

                          </div>
                          <div class="col-md-6">
                            <img src="/<%= element.images[1] %>" alt="Image Preview" id="preview<%= index+1 %>-2"
                              class="image-preview">
                            <input class="form-control image-form" type="file" name="productImage1" id="varient<%= index+1 %>-image2"
                              onchange="previewImage(this, `preview<%= index+1 %>-2`)">
                            <button type="button" class="btn btn-outline-danger mt-2"
                              onclick="openCroppingModal(`preview<%= index+1 %>-2`,'varient<%= index+1 %>-image2')">Crop Image</button>
                          </div>
                        </div>
                        <div class="row mt-5">
                          <div class="col-md-6">
                            <img src="/<%= element.images[2] %>" alt="Image Preview" id="preview<%= index+1 %>-3"
                              class="image-preview">
                            <input class="form-control image-form" type="file" name="productImage1" id="varient<%= index+1 %>-image3"
                              onchange="previewImage(this, 'preview<%= index+1 %>-3')">
                            <button type="button" class="btn btn-outline-danger mt-2"
                              onclick="openCroppingModal(`preview<%= index+1 %>-3`,'varient<%= index+1 %>-image3')">Crop Image</button>
                          </div>
                          <div class="col-md-6">
                            <img src="/<%= element.images[3] %>" alt="Image Preview" id="preview<%= index+1 %>-4"
                              class="image-preview">
                            <input class=" form-control image-form" type="file" name="productImage1"
                              id="varient1-image4" onchange="previewImage(this, 'preview<%= index+1 %>-4')">
                            <button type="button" class="btn btn-outline-danger mt-2"
                              onclick="openCroppingModal(`preview<%= index+1 %>-4`,'varient<%= index+1 %>-image4')">Crop Image</button>
                          </div>
                        </div>

                        <% }) %>

                          <div class="newVarient">
                            <input type="hidden" name="variant_count" id="variant_count" value="1">
                            <button class="btn btn-outline-dark mt-4" id="addVariantButton">New varient </button>
                          </div>
                      </div>
                    </div>



                    <div class="mb-3 mt-5 ">
                      <label for="productDescription" class="form-label"> Description</label>
                      <textarea class="form-control" name="productDescription" id="productDescription" rows="4"
                        required><%= product.product_description%></textarea>
                    </div>

                    <button type="submit" class="btn btn-outline-dark mt-4">Save changes</button>
                    <a href="/admin/products" type="submit" class="btn btn-outline-danger mt-4">Back</a>
                </form>
              </div>
            </div>
          </div>




        </div>
      </div>
  </section>
  <script>

    let variantIndex = document.querySelectorAll('.variant-row').length; // Start with the first variant index
    let cropper;
    let currentPreviewId = '';
    let currentFileInputId = '';
    let currentImageId;


    function previewImage(input, previewId) {
      const preview = document.getElementById(previewId); // Get the image element where the preview will be shown
      const file = input.files[0]; // Get the first file selected by the user
      const reader = new FileReader(); // Create a new FileReader object

      reader.onload = function (e) {
        preview.src = e.target.result; // Set the src of the image element to the data URL of the selected file
      };

      reader.readAsDataURL(file); // Read the file as a data URL
    }



    function openCroppingModal(previewId, fileInputId) {
      currentPreviewId = previewId;
      currentFileInputId = fileInputId;
      const modalElement = document.getElementById('cropperModal');
      const modal = new bootstrap.Modal(modalElement);
      const imageToCrop = document.getElementById('image-to-crop');
      const preview = document.getElementById(previewId);

      // Set the source of the image to crop
      imageToCrop.src = preview.src;

      // Destroy any existing cropper instance
      if (cropper) {
        cropper.destroy();
        cropper = null;
      }

      // Initialize a new Cropper instance
      cropper = new Cropper(imageToCrop, {
        aspectRatio: 1,
      });

      // Show the modal
      modal.show();
    }

    function cropAndSave() {
      if (!cropper) return;

      const croppedCanvas = cropper.getCroppedCanvas();
      const preview = document.getElementById(currentPreviewId);

      // Update the preview image
      preview.src = croppedCanvas.toDataURL('image/jpeg');

      // Convert the cropped image to Blob and update the file input
      croppedCanvas.toBlob(function (blob) {
        const fileInput = document.getElementById(currentFileInputId);
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(new File([blob], `cropped-${currentPreviewId}.jpg`, { type: 'image/jpeg' }));
        fileInput.files = dataTransfer.files;
      });

      // Hide the modal after cropping
      const modalElement = document.getElementById('cropperModal');
      const modal = bootstrap.Modal.getInstance(modalElement);
      if (modal) {
        modal.hide();
      } else {
        // If getInstance is not working, use the direct hide method on the instance
        new bootstrap.Modal(modalElement).hide();
      }

      // Destroy the cropper instance
      if (cropper) {
        cropper.destroy();
        cropper = null;
      }
    }





    document.getElementById('addVariantButton').addEventListener('click', function (e) {
      e.preventDefault(); // Prevent form submission

      const variantSection = document.getElementById('varient');
      const newVariantRow = document.createElement('div'); // Create new variant row
      variantIndex++; // Increment the variant index
      document.getElementById('variant_count').value = variantIndex; // Update the hidden variant count field

      // Define the new variant row HTML
      newVariantRow.classList.add('row', 'variant-row', 'mb-3', 'mt-3');
      newVariantRow.innerHTML = `
        <div class="col-md-3">
            <select class="form-select form-control form-edge" name="productSize[]" id="productSize" required>
                <option selected disabled>Size</option>
                <option value="1">XS</option>
                                      <option>S</option>
                                      <option>M</option>
                                      <option>L</option>
                                      <option>XL</option>
                                      <option>XXL</option>
                                      <option>3XL</option>
            </select>
        </div>
        <div class="col-md-3">
           <select class="form-select form-control form-edge" name="productColor[]" id="productColor" required>
                                      <option selected disabled>Color</option>
                                      <option>RED</option>
                                      <option>BLUE</option>
                                      <option>YELLOW</option>
                                      <option>BLACK</option>
                                      <option>WHITE</option>
                                      <option>PINK</option>
                                      <option>Green</option>
                                      <option>PURPLE</option>
                                      <option>ORANGE</option>
                                      <option>NAVY</option>
                                      <option>MAROON</option>
                                  </select>
        </div>
        <div class="col-md-3">
           <input type="number" class="form-control form-edge" name="productPrice" id="productPrice" placeholder="Price" required>
        </div>
        <div class="col-md-3">
           <input type="number" class="form-control form-edge" name="productStock" id="productStock" placeholder="Stock" required>
        </div>
        
        <div class="mb-3 mt-5 ">
               <label for="productImage" class="form-label">Upload Image</label>
                                <div class="row mt-3">
                                  <div class="col-md-6">
                                    
                                      <img src="/images/cloud-upload-icon-sign-symbol-logo-vector.jpg" alt="Image Preview" id="preview${variantIndex}-1" class="image-preview">
                                      <input class="form-control image-form" type="file" name="productImage${variantIndex}" id="varient${variantIndex}-image1" onchange="previewImage(this, 'preview${variantIndex}-1')" required>
                                      
                                    
                                  </div>
                                  <div class="col-md-6">
                                    <img src="/images/cloud-upload-icon-sign-symbol-logo-vector.jpg" alt="Image Preview" id="preview${variantIndex}-2" class="image-preview">
                                    <input class="form-control image-form" type="file" name="productImage${variantIndex}" id="varient${variantIndex}-image2" onchange="previewImage(this, 'preview${variantIndex}-2')" required>
                                  </div>
                                </div>
                                <div class="row mt-5">
                                  <div class="col-md-6">
                                    <img src="/images/cloud-upload-icon-sign-symbol-logo-vector.jpg" alt="Image Preview" id="preview${variantIndex}-3" class="image-preview">
                                    <input class="form-control image-form" type="file" name="productImage${variantIndex}" id="varient${variantIndex}-image3" onchange="previewImage(this, 'preview${variantIndex}-3')" required>
                                  </div>
                                  <div class="col-md-6">
                                    <img src="/images/cloud-upload-icon-sign-symbol-logo-vector.jpg" alt="Image Preview" id="preview${variantIndex}-4" class="image-preview">
                                    <input class="form-control image-form" type="file" name="productImage${variantIndex}" id="varient${variantIndex}-image4" onchange="previewImage(this, 'preview${variantIndex}-4')" required>
                                  </div>
                                </div>
                                <div class="col-md-12 text-end mt-2">
            <button type="button" class="btn btn-outline-danger remove-variant">remove</button>
        </div>
    `;

      // Add event listener to remove the variant row
      newVariantRow.querySelector('.remove-variant').addEventListener('click', function () {
        newVariantRow.remove();
        variantIndex--; // Decrement the variant index
        document.getElementById('variant_count').value = variantIndex; // Update the hidden variant count field
      });

      variantSection.appendChild(newVariantRow); // Append the new variant row
    });


  </script>









  <%- include ('../partial/admin-footer')-%>